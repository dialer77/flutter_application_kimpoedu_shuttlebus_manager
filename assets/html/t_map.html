<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>TMap</title>
        <script src="//code.jquery.com/jquery-3.2.1.min.js"></script>
        <script src="https://apis.openapi.sk.com/tmap/vectorjs?version=1&appKey=APP_KEY"></script>
        <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=APP_KEY"></script>
        <style>
            body, html { 
                margin: 0; 
                padding: 0; 
                width: 100%; 
                height: 100%; 
                overflow: hidden;
            }
            #map_div { 
                width: 100%; 
                height: 100%; 
            }
        </style>
    </head>
    <body onload="initTmap()">
        <div id="map_div"></div>
        <script type="text/javascript">

            var map;
            var markers = {};
            // 페이지가 로딩이 된 후 호출하는 함수입니다.
            function initTmap(){
                // 기본 변수 초기화
                window.map = null;
                window.infoWindow = null;
                window.markers = {};
                window.routes = {};
                
                try {
                    // map 생성
                    // Tmapv3.Map을 이용하여, 지도가 들어갈 div, 넓이, 높이를 설정합니다.
                    map = new Tmapv2.Map("map_div", { // 지도가 생성될 div
                        center: new Tmapv2.LatLng(37.566481622437934, 126.98502302169841), // 서울시청
                        width: "100%", // 지도의 넓이
                        height: "100%", // 지도의 높이
                        zoom: 15, // 지도 줌레벨
                        scrollwheel : true
                    });
                    
                    // 인포윈도우 생성
                    infoWindow = new Tmapv3.InfoWindow();

                    sendMessageToFlutter({
                            event: 'mapInitialized',
                            status: 'success'
                        });
                    
                    console.log("TMap 지도 초기화 완료");
                } catch (error) {
                    console.error("TMap 지도 초기화 오류:", error);
                    
                    if (window.chrome && window.chrome.webview) {
                        window.chrome.webview.postMessage(JSON.stringify({
                            event: 'mapInitialized',
                            status: 'error',
                            message: error.toString()
                        }));
                    }
                }
            }

            function sendMessageToFlutter(data) {
                window.chrome.webview.postMessage(JSON.stringify(data));
            }
            
            var queueSearchId = [];
            // 위치 검색 함수
            function searchLocation(searchId, keyword) {
                // 기존 검색 결과 마커 삭제
                clearSearchMarkers();
                
                var headers = {}; 
                headers["appKey"] = "APP_KEY"; // 실제 앱키로 교체 필요
                
                $.ajax({
                    method: "GET",
                    headers: headers,
                    url: "https://apis.openapi.sk.com/tmap/pois?version=1&format=json&callback=result",
                    async: false,
                    data: {
                        "searchKeyword": keyword,
                        "resCoordType": "EPSG3857",
                        "reqCoordType": "WGS84GEO",
                        "count": 10
                    },
                    success: function(response) {
                        var results = [];
                        var resultpoisData = response.searchPoiInfo.pois.poi;
                        
                        // 기존 마커 제거
                        clearSearchMarkers();
                        
                        // 검색 마커를 저장할 배열
                        window.searchMarkers = window.searchMarkers || [];
                        
                        var positionBounds = new Tmapv2.LatLngBounds();
                        
                        for(var k in resultpoisData) {
                            var noorLat = Number(resultpoisData[k].noorLat);
                            var noorLon = Number(resultpoisData[k].noorLon);
                            var name = resultpoisData[k].name;
                            
                            var pointCng = new Tmapv2.Point(noorLon, noorLat);
                            var projectionCng = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(pointCng);
                            
                            var lat = projectionCng._lat;
                            var lon = projectionCng._lng;
                            
                            var markerPosition = new Tmapv2.LatLng(lat, lon);
                            
                            var marker = new Tmapv2.Marker({
                                position: markerPosition,
                                icon: "/upload/tmap/marker/pin_b_m_" + k + ".png",
                                iconSize: new Tmapv2.Size(24, 38),
                                map: map
                            });
                            
                            window.searchMarkers.push(marker);
                            positionBounds.extend(markerPosition);
                            
                            // 결과 배열에 추가
                            results.push({
                                id: resultpoisData[k].id,
                                name: name,
                                lat: lat,
                                lng: lon,
                                distance: resultpoisData[k].radius || 0
                            });
                        }
                        
                        // 검색 결과 경계로 지도 조정
                        if (results.length > 0) {
                            map.panToBounds(positionBounds);
                            map.zoomOut();
                        }
                        
                        // 검색 결과를 Flutter로 전송
                        sendMessageToFlutter({
                            event: 'searchComplete',
                            searchId: searchId,
                            results: results
                        });
                        
                    },
                    error: function(request, status, error) {
                        console.error("검색 오류:", error);
                        sendMessageToFlutter({
                            event: 'searchComplete',
                            searchId: searchId,
                            error: error.toString(),
                            results: []
                        });
                    }
                });
            }

            // 마커 클리어 함수
            function clearMarkers() {
                for (var id in markers) {
                    markers[id].setMap(null);
                }
                markers = {};
            }

            // 마커 제거 함수
            function removeMarker(id){
                markers[id].setMap(null);
                delete markers[id];
            }

            //마커의 옵션을 설정해주는 함수입니다.
            function addMarker(id, title, lon, lat, type, count){
                var iconUrl = "";
                switch (type) {
                    case "start":
                        iconUrl = "/upload/tmap/marker/pin_r_m_s.png";
                        break;
                    case "end":
                        iconUrl = "/upload/tmap/marker/pin_r_m_e.png";
                        break;
                    case "waypoint":
                        iconUrl = "/upload/tmap/marker/pin_b_m_" + count + ".png";
                        break;
                }

                // 마커 생성
                var marker = new Tmapv2.Marker({
                    position: new Tmapv2.LatLng(lat,lon), //Marker의 중심좌표 설정.
                    map: map, //Marker가 표시될 Map 설정..
                });
                markers[id] = marker;
            }
            
            // 경유지 최적화
            function optimizeRoute(searchId, data) {
                var results = [];
                // 경로 최적화 요청
                var headers = {}; 
                headers["appKey"] = "APP_KEY"; // 실제 앱키로 교체 필요

                console.log(data);


                $.ajax({
                    method: "POST",
                    headers: headers,
                    url:"https://apis.openapi.sk.com/tmap/routes/routeOptimization20?version=1&format=json",
                    async: false,
                    data: JSON.stringify(data),
                    success: function(response) {
                        console.log(response);
                        var resultData = response.properties;
			            var resultFeatures = response.features;
                        
                        // 결과 출력
                        var tDistance = "총 거리 : " + (resultData.totalDistance/1000).toFixed(1) + "km,  ";
                        var tTime = "총 시간 : " + (resultData.totalTime/60).toFixed(0) + "분,  ";
                        var tFare = "총 요금 : " + resultData.totalFare + "원";
                        
                        var positionBounds = new Tmapv2.LatLngBounds();
                        
                        for(var i in resultFeatures) {
                            var geometry = resultFeatures[i].geometry;
                            var properties = resultFeatures[i].properties;
                            var polyline_;
                            
                            drawInfoArr = [];
                            
                            if(geometry.type == "LineString") {
                                for(var j in geometry.coordinates){
                                    // 경로들의 결과값(구간)들을 포인트 객체로 변환 
                                    var latlng = new Tmapv2.Point(geometry.coordinates[j][0], geometry.coordinates[j][1]);
                                    // 포인트 객체를 받아 좌표값으로 변환
                                    var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(latlng);
                                    // 포인트객체의 정보로 좌표값 변환 객체로 저장
                                    var convertChange = new Tmapv2.LatLng(convertPoint._lat, convertPoint._lng);
                                    
                                    drawInfoArr.push(convertChange);
                                }

                                polyline_ = new Tmapv2.Polyline({
                                    path : drawInfoArr,
                                    strokeColor : "#FF0000",
                                    strokeWeight: 6,
                                    map : map
                                });
                            }

                            results.push(properties);
                        }
                        
                        // 검색 결과를 Flutter로 전송
                        sendMessageToFlutter({
                            event: 'optimizeRouteComplete',
                            searchId: searchId,
                            results: results
                        });
                        
                    },
                    error: function(request, status, error) {
                        console.error("경로 최적화 오류:", error);
                        sendMessageToFlutter({
                            event: 'optimizeRouteComplete',
                            searchId: searchId,
                            error: error.toString(),
                            results: []
                        });
                    }
                });
            }
            

            // 콘솔 로그 재정의 - Flutter로 전송
            const originalConsoleLog = console.log;
            const originalConsoleError = console.error;
            
            console.log = function() {
                originalConsoleLog.apply(console, arguments);
                const message = Array.from(arguments).map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg) : arg
                ).join(' ');
                
                if (window.chrome && window.chrome.webview) {
                    sendMessageToFlutter({
                        event: 'console',
                        type: 'log',
                        message: message
                    });
                }
            };
            
            console.error = function() {
                originalConsoleError.apply(console, arguments);
                const message = Array.from(arguments).map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg) : arg
                ).join(' ');
                
                if (window.chrome && window.chrome.webview) {
                    sendMessageToFlutter({
                        event: 'console',
                        type: 'error',
                        message: message
                    });
                }
            };
        </script>
    </body>
</html>